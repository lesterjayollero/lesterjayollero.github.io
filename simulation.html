<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Interactive Intersection — movement capacities & LOS</title>
<meta name="author" content="Lester Jay Ollero">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* --- page chrome, matching your site --- */
  body { font-family: "Segoe UI", Roboto, sans-serif; margin:0; background:#fafafa; color:#222; }
  .navbar { background:#fff; border-bottom:1px solid #ddd; position:sticky; top:0; z-index:100; }
  .nav-container { display:flex; justify-content:space-between; align-items:center; padding:12px 24px; max-width:1100px; margin:0 auto; }
  .nav-logo { font-size:1.2rem; font-weight:600; color:#003049; text-decoration:none; }
  .container { max-width:1100px; margin:18px auto; padding:0 18px; }

  h1 { color:#003049; font-size:1.3rem; border-bottom:3px solid #0077b6; padding-bottom:6px; margin-bottom:12px; display:inline-block; }

  .controls { display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 12px; }
  .card { background:#fff; border-radius:8px; padding:8px 12px; border:1px solid #eee; box-shadow:0 1px 3px rgba(0,0,0,0.03); }
  select, input[type=checkbox] { font-size:0.95rem; padding:6px; }

  .layout { display:grid; grid-template-columns: 520px 1fr; gap:14px; align-items:start; }
  @media (max-width:980px) { .layout{ grid-template-columns:1fr; } }

  /* svg panel */
  .svg-wrap { background:#fff; padding:12px; border-radius:8px; border:1px solid #eee; position:relative; }
  svg { width:100%; height:auto; display:block; }

  /* improved arrow styles */
  .mov { cursor:pointer; stroke-linecap:round; stroke-linejoin:round; transition: transform .08s ease, opacity .12s ease; }
  .mov:hover { transform: scale(1.03); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.12)); }
  .leg-area { fill: rgba(11,72,107,0.06); stroke:#0077b6; stroke-width:1.6; cursor:pointer; }
  .leg-area.missing { fill:#f4f4f4; stroke:#ccc; opacity:0.6; cursor:not-allowed; }

  .mov-label { font-size:11px; pointer-events:none; fill:#003049; font-weight:700; }

  /* floating editor */
  .editor {
    position:absolute;
    background:#fff;
    border:1px solid #bbb;
    box-shadow:0 8px 26px rgba(0,0,0,0.12);
    border-radius:6px;
    padding:10px;
    z-index:220;
    width:240px;
    display:none;
    font-size:13px;
  }
  .editor label { font-size:12px; color:#444; display:block; margin-top:6px; }
  .editor input[type=number] { width:100%; padding:6px; margin-top:6px; border-radius:4px; border:1px solid #ccc; }

  .btn { background:#0077b6; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:600; }
  .btn.secondary { background:#fff; color:#0077b6; border:1px solid #0077b6; }

  .panel { background:#fff; padding:12px; border-radius:8px; border:1px solid #eee; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th, td { padding:8px 6px; border-bottom:1px solid #eee; text-align:left; font-size:0.95rem; }
  th { background:#fbfdff; color:#003049; font-weight:700; }

  .los-pill { padding:4px 8px; border-radius:12px; color:#fff; font-weight:700; font-size:0.85rem; display:inline-block; }
  .A{ background:#2ecc71; } .B{ background:#4aa3d9; } .C{ background:#ffd54f; color:#222 } .D{ background:#ff9f1c } .E{ background:#ff4d4d } .F{ background:#8b0000 }

  .legend { display:flex; gap:6px; margin-top:6px; align-items:center; flex-wrap:wrap; }
  .legend .item { display:flex; gap:6px; align-items:center; font-size:0.9rem; }
  .swatch { width:18px; height:12px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,0.06); }

  canvas { width:100%; max-height:220px; margin-top:8px; }
</style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">Lester Jay Ollero</a>
      <div class="menu-toggle" id="mobile-menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
      <ul class="nav-menu">
        <li><a href="index.html#home">Home</a></li>
        <li><a href="research.html">Research</a></li>
        <li><a href="simulation.html" class="active">Simulation</a></li>
        <li><a href="publications.html">Publications</a></li>
        <li><a href="awards.html">Awards</a></li>
        <li><a href="projects.html">Projects</a></li>
      </ul>
    </div>
  </nav>
  <div class="container">
    <h1>Interactive Intersection — movement capacities & LOS</h1>

    <div class="controls">
      <div class="card">
        <label>Intersection type</label><br/>
        <select id="typeSel">
          <option value="4">4-legged</option>
          <option value="3">3-legged (T)</option>
        </select>
      </div>

      <div class="card">
        <label>Legend</label>
        <div class="legend" style="margin-top:6px;">
          <div class="item"><span class="swatch" style="background:#2ecc71"></span> A &lt;0.20</div>
          <div class="item"><span class="swatch" style="background:#4aa3d9"></span> B 0.21–0.50</div>
          <div class="item"><span class="swatch" style="background:#ffd54f"></span> C 0.51–0.70</div>
          <div class="item"><span class="swatch" style="background:#ff9f1c"></span> D 0.71–0.85</div>
          <div class="item"><span class="swatch" style="background:#ff4d4d"></span> E 0.86–1.00</div>
          <div class="item"><span class="swatch" style="background:#8b0000"></span> F &gt;1.00</div>
        </div>
      </div>

      <div class="card">
        <label>Actions</label><br/>
        <div style="margin-top:6px; display:flex; gap:8px;">
          <button id="resetBtn" class="btn secondary">Reset</button>
          <button id="calcBtn" class="btn">Recalculate</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="svg-wrap panel" style="position:relative;">
        <!-- floating editor -->
        <div id="editor" class="editor" role="dialog" aria-hidden="true">
          <div id="editorTitle" style="font-weight:700;color:#003049">Edit</div>
          <div id="editorBody"></div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="saveBtn" class="btn">Save</button>
            <button id="closeBtn" class="btn secondary">Close</button>
          </div>
        </div>

        <!-- improved SVG arrows: center at 210,210 -->
        <svg id="svg" viewBox="0 0 420 420" xmlns="http://www.w3.org/2000/svg" aria-label="Intersection diagram">
          <!-- center island -->
          <rect x="160" y="160" width="100" height="100" rx="8" fill="#fff" stroke="#0077b6" stroke-width="2"/>

          <!-- leg areas -->
          <rect id="legN" class="leg-area" x="190" y="0" width="40" height="160" rx="6"></rect>
          <rect id="legS" class="leg-area" x="190" y="260" width="40" height="160" rx="6"></rect>
          <rect id="legW" class="leg-area" x="0" y="190" width="160" height="40" rx="6"></rect>
          <rect id="legE" class="leg-area" x="260" y="190" width="160" height="40" rx="6"></rect>

          <!-- tapered arrow shapes (movement-level). For clarity each arrow is a path with id like N_left -->
          <!-- NORTH approach (pointing south) -->
          <path id="N_left"  class="mov" d="M200 148 C180 130 170 120 170 110 L186 110 L186 140 Z" />
          <path id="N_thru"  class="mov" d="M210 150 L210 110" stroke-width="10" stroke-linecap="round" stroke="#4d4d4d" fill="none"/>
          <path id="N_right" class="mov" d="M220 148 C240 130 250 120 250 110 L234 110 L234 140 Z" />

          <!-- EAST approach (pointing west) -->
          <path id="E_left"  class="mov" d="M260 200 C278 180 288 170 298 170 L298 186 L268 186 Z" />
          <path id="E_thru"  class="mov" d="M260 210 L300 210" stroke-width="10" stroke-linecap="round" stroke="#4d4d4d" fill="none"/>
          <path id="E_right" class="mov" d="M260 220 C278 240 288 250 298 250 L298 234 L268 234 Z" />

          <!-- SOUTH approach (pointing north) -->
          <path id="S_left"  class="mov" d="M210 272 C230 290 240 300 240 310 L224 310 L224 280 Z" />
          <path id="S_thru"  class="mov" d="M200 270 L200 310" stroke-width="10" stroke-linecap="round" stroke="#4d4d4d" fill="none"/>
          <path id="S_right" class="mov" d="M200 282 C180 300 170 310 170 320 L186 320 L186 290 Z" />

          <!-- WEST approach (pointing east) -->
          <path id="W_left"  class="mov" d="M160 210 C142 230 132 240 122 240 L122 224 L152 224 Z" />
          <path id="W_thru"  class="mov" d="M160 200 L120 200" stroke-width="10" stroke-linecap="round" stroke="#4d4d4d" fill="none"/>
          <path id="W_right" class="mov" d="M160 220 C142 200 132 190 122 190 L122 206 L152 206 Z" />

          <!-- approach totals as circles -->
          <circle id="totN" cx="210" cy="150" r="14" fill="#fff" stroke="#444"></circle>
          <text id="totNtxt" x="210" y="154" text-anchor="middle" font-size="11" fill="#003049">0.00</text>

          <circle id="totE" cx="270" cy="210" r="14" fill="#fff" stroke="#444"></circle>
          <text id="totEtxt" x="270" y="214" text-anchor="middle" font-size="11" fill="#003049">0.00</text>

          <circle id="totS" cx="210" cy="270" r="14" fill="#fff" stroke="#444"></circle>
          <text id="totStxt" x="210" y="274" text-anchor="middle" font-size="11" fill="#003049">0.00</text>

          <circle id="totW" cx="150" cy="210" r="14" fill="#fff" stroke="#444"></circle>
          <text id="totWtxt" x="150" y="214" text-anchor="middle" font-size="11" fill="#003049">0.00</text>
        </svg>

      </div>

      <div>
        <div class="panel">
          <h3 style="margin-top:0;color:#003049">Results</h3>
          <div class="muted">Click an arrow to edit movement volume & movement capacity. Leg totals are sums of movements.</div>

          <table aria-label="Results">
            <thead><tr><th>Approach</th><th>Left</th><th>Thru</th><th>Right</th><th>Total</th><th>v/c (leg)</th><th>LOS</th></tr></thead>
            <tbody id="resultsBody"></tbody>
          </table>

          <canvas id="vcBar" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Data model: movement volumes & movement-specific capacities
   Structure: model[arm][mov] = { vol, cap }
   arms: N,E,S,W ; mov keys: left,thru,right
   ========================= */
const arms = ['N','E','S','W'];
const moves = ['left','thru','right'];

// initialize with reasonable defaults
const model = {
  N: { present:true, left:{vol:40,cap:200},  thru:{vol:600,cap:1000}, right:{vol:50,cap:200} },
  E: { present:true, left:{vol:30,cap:200},  thru:{vol:500,cap:1000}, right:{vol:40,cap:200} },
  S: { present:true, left:{vol:60,cap:200},  thru:{vol:700,cap:1000}, right:{vol:50,cap:200} },
  W: { present:true, left:{vol:20,cap:200},  thru:{vol:450,cap:1000}, right:{vol:30,cap:200} },
};

/* LOS thresholds based on v/c (movement-level and leg-level) */
function determineLOS(vc) {
  if (vc < 0.20) return 'A';
  if (vc <= 0.50) return 'B';
  if (vc <= 0.70) return 'C';
  if (vc <= 0.85) return 'D';
  if (vc <= 1.00) return 'E';
  return 'F';
}
const losColor = { A:'#2ecc71', B:'#4aa3d9', C:'#ffd54f', D:'#ff9f1c', E:'#ff4d4d', F:'#8b0000' };

/* DOM refs */
const svg = document.getElementById('svg');
const editor = document.getElementById('editor');
const editorTitle = document.getElementById('editorTitle');
const editorBody = document.getElementById('editorBody');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');

const typeSel = document.getElementById('typeSel');
const resetBtn = document.getElementById('resetBtn');
const calcBtn = document.getElementById('calcBtn');
const resultsBody = document.getElementById('resultsBody');

const vcCtx = document.getElementById('vcBar').getContext('2d');
const vcChart = new Chart(vcCtx, {
  type:'bar',
  data: { labels: [], datasets:[{ label:'leg v/c', data:[], backgroundColor:[] }]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, max:1.6, title:{display:true,text:'v/c'} } } }
});

/* utility */
function $(id){return document.getElementById(id);}

/* Movement elements */
const movEls = {
  'N_left': $('N_left'), 'N_thru': $('N_thru'), 'N_right': $('N_right'),
  'E_left': $('E_left'), 'E_thru': $('E_thru'), 'E_right': $('E_right'),
  'S_left': $('S_left'), 'S_thru': $('S_thru'), 'S_right': $('S_right'),
  'W_left': $('W_left'), 'W_thru': $('W_thru'), 'W_right': $('W_right')
};

/* approach circles/texts */
const totEls = { N: $('totN'), Ntxt: $('totNtxt'), E: $('totE'), Etxt: $('totEtxt'), S: $('totS'), Stxt: $('totStxt'), W: $('totW'), Wtxt: $('totWtxt') };

/* attach click handlers to movements */
Object.keys(movEls).forEach(key => {
  const el = movEls[key];
  if (!el) return;
  el.addEventListener('click', (ev) => {
    const [arm,mov] = key.split('_');
    if (!model[arm].present) return;
    openEditorForMovement(ev, arm, mov);
  });
});

/* attach click to leg areas to toggle presence (for 3-leg) and to edit all movements of leg */
$('legN').addEventListener('click', (ev)=> { openEditorForLeg(ev,'N'); });
$('legE').addEventListener('click', (ev)=> { openEditorForLeg(ev,'E'); });
$('legS').addEventListener('click', (ev)=> { openEditorForLeg(ev,'S'); });
$('legW').addEventListener('click', (ev)=> { openEditorForLeg(ev,'W'); });

/* editor context */
let editCtx = null; // {type:'mov'|'leg', arm, mov}

/* open editor for a movement (single movement) */
function openEditorForMovement(ev, arm, mov) {
  editCtx = { type:'mov', arm, mov };
  editorTitle.textContent = `Edit ${arm} → ${mov}`;
  editorBody.innerHTML = `
    <label>Volume (veh/hr)</label>
    <input id="inpVol" type="number" min="0" step="10" value="${model[arm][mov].vol}">
    <label>Movement capacity (veh/hr)</label>
    <input id="inpCap" type="number" min="10" step="10" value="${model[arm][mov].cap}">
    <div style="font-size:12px;color:#555;margin-top:6px">Leg total capacity (sum movements) shown in results.</div>
  `;
  positionEditor(ev);
  showEditor();
}

/* open editor to edit all movements (leg-level panel) */
function openEditorForLeg(ev, arm) {
  // toggle presence on alt-click
  if (ev.altKey) {
    model[arm].present = !model[arm].present;
    recalcAndRender();
    return;
  }
  editCtx = { type:'leg', arm };
  editorTitle.textContent = `Edit ${arm} (all movements)`;
  editorBody.innerHTML = `
    <label>Left (veh/hr)</label>
    <input id="inpL" type="number" min="0" step="10" value="${model[arm].left.vol}">
    <label>Left capacity (veh/hr)</label>
    <input id="inpLC" type="number" min="10" step="10" value="${model[arm].left.cap}">
    <label>Through (veh/hr)</label>
    <input id="inpT" type="number" min="0" step="10" value="${model[arm].thru.vol}">
    <label>Through capacity (veh/hr)</label>
    <input id="inpTC" type="number" min="10" step="10" value="${model[arm].thru.cap}">
    <label>Right (veh/hr)</label>
    <input id="inpR" type="number" min="0" step="10" value="${model[arm].right.vol}">
    <label>Right capacity (veh/hr)</label>
    <input id="inpRC" type="number" min="10" step="10" value="${model[arm].right.cap}">
    <div style="font-size:12px;color:#555;margin-top:6px">Tip: Alt-click a leg to toggle presence (show/hide approach).</div>
  `;
  positionEditor(ev);
  showEditor();
}

/* position editor near click inside svg container */
function positionEditor(ev) {
  const rect = svg.getBoundingClientRect();
  const x = ev.clientX - rect.left + 8;
  const y = ev.clientY - rect.top + 8;
  editor.style.left = x + 'px';
  editor.style.top = y + 'px';
}

/* show/hide editor */
function showEditor() { editor.style.display = 'block'; editor.setAttribute('aria-hidden','false'); }
function hideEditor() { editor.style.display = 'none'; editor.setAttribute('aria-hidden','true'); editCtx = null; }

/* save handler */
saveBtn.addEventListener('click', ()=> {
  if (!editCtx) { hideEditor(); return; }
  if (editCtx.type === 'mov') {
    const v = Math.max(0, Number(document.getElementById('inpVol').value) || 0);
    const c = Math.max(1, Number(document.getElementById('inpCap').value) || 1);
    model[editCtx.arm][editCtx.mov].vol = v;
    model[editCtx.arm][editCtx.mov].cap = c;
  } else {
    const L = Math.max(0, Number(document.getElementById('inpL').value)||0);
    const LC = Math.max(1, Number(document.getElementById('inpLC').value)||1);
    const T = Math.max(0, Number(document.getElementById('inpT').value)||0);
    const TC = Math.max(1, Number(document.getElementById('inpTC').value)||1);
    const R = Math.max(0, Number(document.getElementById('inpR').value)||0);
    const RC = Math.max(1, Number(document.getElementById('inpRC').value)||1);
    model[editCtx.arm].left.vol = L; model[editCtx.arm].left.cap = LC;
    model[editCtx.arm].thru.vol = T; model[editCtx.arm].thru.cap = TC;
    model[editCtx.arm].right.vol = R; model[editCtx.arm].right.cap = RC;
    model[editCtx.arm].present = true;
  }
  hideEditor();
  recalcAndRender();
});
closeBtn.addEventListener('click', ()=> { hideEditor(); });

/* toggles and controls */
typeSel.addEventListener('change', ()=> {
  const t = typeSel.value;
  if (t === '3') {
    // if all present, disable East by default
    if (model.N.present && model.E.present && model.S.present && model.W.present) {
      model.E.present = false;
      $('legE').classList.add('missing');
    }
  } else {
    // make sure all visible (if previously toggled manually, keep user choice)
  }
  recalcAndRender();
});
resetBtn.addEventListener('click', ()=> {
  // restore defaults quickly
  model.N = { present:true, left:{vol:40,cap:200},  thru:{vol:600,cap:1000}, right:{vol:50,cap:200} };
  model.E = { present:true, left:{vol:30,cap:200},  thru:{vol:500,cap:1000}, right:{vol:40,cap:200} };
  model.S = { present:true, left:{vol:60,cap:200},  thru:{vol:700,cap:1000}, right:{vol:50,cap:200} };
  model.W = { present:true, left:{vol:20,cap:200},  thru:{vol:450,cap:1000}, right:{vol:30,cap:200} };
  // remove missing class
  ['N','E','S','W'].forEach(a => $('leg'+a).classList.remove('missing'));
  recalcAndRender();
});
calcBtn.addEventListener('click', ()=> recalcAndRender());

/* close editor on outside click */
document.addEventListener('click', (ev)=> {
  const insideEditor = ev.target.closest('.editor');
  const insideSvg = ev.target.closest('svg');
  if (!insideEditor && !insideSvg) hideEditor();
});

/* recalc and render */
function recalcAndRender() {
  // update movement colors based on movement-level v/c (volume / movement capacity)
  const rows = [];
  const labels = []; const values = []; const colors = [];

  arms.forEach(arm => {
    if (!model[arm].present) {
      // hide visuals for that arm: dim leg area and arrows
      $('leg'+arm).classList.add('missing');
      ['left','thru','right'].forEach(mov => {
        const el = movEls[arm + '_' + mov];
        if (el) el.style.opacity = 0.18;
      });
      // clear totals
      if (totEls[arm+'txt']) totEls[arm+'txt'].textContent = '';
      return;
    } else {
      $('leg'+arm).classList.remove('missing');
      ['left','thru','right'].forEach(mov => {
        const el = movEls[arm + '_' + mov];
        if (el) el.style.opacity = 1.0;
      });
    }

    const mvLeft = model[arm].left.vol, capL = model[arm].left.cap;
    const mvThru = model[arm].thru.vol, capT = model[arm].thru.cap;
    const mvRight = model[arm].right.vol, capR = model[arm].right.cap;

    // movement v/c
    const vcL = capL ? mvLeft / capL : 0;
    const vcT = capT ? mvThru / capT : 0;
    const vcR = capR ? mvRight / capR : 0;

    // leg total (sum volumes) and a chosen leg capacity: we can either sum movement capacities or use max; we will use sum of movement capacities here
    const totalVol = mvLeft + mvThru + mvRight;
    const legCapSum = capL + capT + capR;
    const legVc = legCapSum ? totalVol / legCapSum : 0;
    const legLos = determineLOS(legVc);

    // color arrows individually based on movement-level LOS
    const movs = { left: vcL, thru: vcT, right: vcR };
    Object.keys(movs).forEach(mov => {
      const el = movEls[arm + '_' + mov];
      if (!el) return;
      const mv = movs[mov];
      const mvLos = determineLOS(mv);
      const color = losColor[mvLos] || '#ccc';
      // if arrow is stroked path (through arrows are strokes), handle differently
      if (el.tagName === 'path' && el.getAttribute('stroke-width')) {
        // through arrow is a stroke path
        el.setAttribute('stroke', shadeColor(color,-12));
        el.setAttribute('stroke-width', Math.max(8, 8 + mv*6));
        el.setAttribute('fill', 'none');
      } else {
        // filled arrow
        el.setAttribute('fill', color);
        el.setAttribute('stroke', shadeColor(color,-18));
      }
    });

    // update totals circle
    const circ = totEls[arm];
    const txt = totEls[arm+'txt'];
    if (circ) circ.setAttribute('fill', losColor[legLos] || '#fff');
    if (txt) txt.textContent = legVc.toFixed(2);

    // push to results table
    rows.push({ arm, left:mvLeft, thru:mvThru, right:mvRight, total:totalVol, legCap:legCapSum, legVc, los:legLos });

    labels.push(arm);
    values.push(Number(legVc.toFixed(2)));
    colors.push(losColor[legLos] || '#888');
  });

  // render results table
  resultsBody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${r.arm}</strong></td>
      <td>${r.left}</td><td>${r.thru}</td><td>${r.right}</td>
      <td>${r.total}</td>
      <td>${r.legVc.toFixed(2)}</td>
      <td><span class="los-pill ${r.los}">LOS ${r.los}</span></td>`;
    resultsBody.appendChild(tr);
  });

  // update bar chart
  vcChart.data.labels = labels;
  vcChart.data.datasets[0].data = values;
  vcChart.data.datasets[0].backgroundColor = colors;
  vcChart.update();
}

/* minor color shade util for stroke */
function shadeColor(hex, percent) {
  if (!hex) return hex;
  const f = hex.slice(1);
  const t = percent < 0 ? 0 : 255;
  const p = Math.abs(percent)/100;
  const R = Math.round((t - parseInt(f.substring(0,2),16))*p + parseInt(f.substring(0,2),16));
  const G = Math.round((t - parseInt(f.substring(2,4),16))*p + parseInt(f.substring(2,4),16));
  const B = Math.round((t - parseInt(f.substring(4,6),16))*p + parseInt(f.substring(4,6),16));
  return `rgb(${R},${G},${B})`;
}

/* initial render */
recalcAndRender();

/* keyboard: Esc closes editor */
document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') hideEditor(); });

</script>
</body>
</html>
